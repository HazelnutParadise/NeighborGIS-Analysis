<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeighborGIS 納博聚思</title>
    <!-- Canva 常用字體、Leaflet 與 Choices.js 樣式 -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Poppins:400,600&display=swap">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
    <link rel="stylesheet" href="assets/style.css" />
</head>

<body>
    <header>
        <div class="fixed-header">
            <h1>
                <span>NeighborGIS</span>
                <span class="bigger-h1">納博聚思</span>
            </h1>
            <div class="progress-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div class="page-tabs">
                <button class="tab-btn active" data-page="page1">鄰里DNA</button>
                <button class="tab-btn" data-page="page2">使用說明</button>
                <button class="tab-btn" data-page="page3">關於我們</button>
            </div>
        </div>
        <script>
            const PROGRESS_BAR = document.getElementById('progressBar');

            // 進度條控制函數
            function showProgress() {
                PROGRESS_BAR.classList.add('loading');
            }
            showProgress();

            function hideProgress() {
                PROGRESS_BAR.classList.remove('loading');
            }

        </script>
    </header>

    <script src="assets/anti_cache.js"></script>

    <!-- Leaflet 與 Choices.js -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                hideProgress()
            }, 1000); // 延遲1秒後隱藏進度條
        });
    </script>

    <main id="app">
        <div class="left-right-btn" id="prev-btn"></div>
        <div class="page-container">
            <!-- 第一頁：鄰里DNA -->
            <div class="page" id="page1">
                <div class="page-content">
                    <div class="container">
                        <h2>地址查詢</h2>
                        <p class="description">輸入您的地址來查尋鄰里相關資訊</p>
                        <p class="notice">目前台北市以外地區的資料可能不完整</p>
                        <div class="input-rows">
                            <div class="input-row">
                                <label for="address">地址</label>
                                <input id="address" class="text-input" type="text" placeholder="輸入地址" required>
                            </div>
                        </div>
                        <div class="input-rows">
                            <button id="searchBtn" type="button">查詢</button>
                        </div>
                        <div id="map"></div>
                        <div id="result" class="result-box">查詢結果將顯示於此。</div>
                        <script>
                            const SPINNER_HTML = `<div class="spinner-wrapper" style="width: 50px; margin: auto;">
                                <div class="spinner">
                                    <svg viewBox="22 22 44 44">
                                        <circle class="bg" cx="44" cy="44" r="20.2" />
                                        <circle class="fg" cx="44" cy="44" r="20.2" />
                                    </svg>
                                </div>
                            </div>`;
                            const SEARCH_BTN = document.getElementById('searchBtn');
                            const RESULT_DIV = document.getElementById('result');


                            // Leaflet 地圖初始化
                            let map = L.map('map').setView([23.5, 121], 7);
                            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);
                            let marker;

                            SEARCH_BTN.addEventListener('click', async () => {
                                const original_btn_text = SEARCH_BTN.innerText;
                                const original_result_text = RESULT_DIV.innerText;
                                SEARCH_BTN.disabled = true;
                                SEARCH_BTN.innerText = '查詢中...';
                                RESULT_DIV.innerHTML = SPINNER_HTML;
                                // 顯示進度條
                                showProgress();

                                const address = document.getElementById('address').value;
                                if (!address) {
                                    SEARCH_BTN.disabled = false;
                                    SEARCH_BTN.innerText = original_btn_text;
                                    RESULT_DIV.innerText = original_result_text;
                                    hideProgress();
                                    return alert('請輸入地址');
                                }
                                try {
                                    const res = await fetch(`/api/intersect/${encodeURIComponent(address)}`)
                                    const resJson = await res.json();
                                    if (!res.ok) {
                                        RESULT_DIV.innerHTML = `查詢失敗，伺服器 ${res.status}`;
                                        hideProgress();
                                        return alert(`查詢失敗，伺服器 ${res.status}` + resJson ? `\n${resJson.message}` : '');
                                    }
                                    const data = resJson.data;
                                    const coordinate = data.coordinate;
                                    const lat = Number(coordinate.lat);
                                    const lng = Number(coordinate.lng);
                                    const zoning = data.zoning;
                                    RESULT_DIV.innerText =
                                        `地址：${data.address}\n` +
                                        `經度：${lng}\n` +
                                        `緯度：${lat}\n` +
                                        `使用分區：${zoning.zone ? zoning.zone : '無資料'}\n` +
                                        `容積率：${zoning.far ? `${zoning.far}%` : '無資料'}\n` +
                                        `建蔽率：${zoning.bcr ? `${zoning.bcr}%` : '無資料'}\n` +
                                        // 若查不到使用分區，則判定該點不在台北市，顯示為無資料
                                        `是否為公有地：${zoning.is_public_land && zoning.zone ? (zoning.is_public_land === "Y" ? '是' : '否') : '無資料'}`;

                                    // 更新土地資訊區塊
                                    document.getElementById('zoning-details').innerHTML = `
                                        <h3>土地使用分區</h3>
                                        <p>使用分區：${zoning.zone ? zoning.zone : '無資料'}</p>
                                        <p>容積率：${zoning.far ? `${zoning.far}%` : '無資料'}</p>
                                        <p>建蔽率：${zoning.bcr ? `${zoning.bcr}%` : '無資料'}</p>
                                        <p>是否為公有地：${zoning.is_public_land && zoning.zone ? (zoning.is_public_land === "Y" ? '是' : '否') : '無資料'}</p>
                                    `;

                                    // 標記地圖
                                    if (!isNaN(lat) && !isNaN(lng) && lat !== 0 && lng !== 0) {
                                        if (marker) map.removeLayer(marker);
                                        marker = L.marker([lat, lng]).addTo(map);
                                        marker.bindPopup(address).openPopup();
                                        map.setView([lat, lng], 16);
                                    } else {
                                        if (marker) {
                                            map.removeLayer(marker);
                                            marker = null;
                                        }
                                    }
                                }
                                catch (error) {
                                    RESULT_DIV.innerHTML = `查詢失敗，請稍後再試`;
                                    console.error('Error:', error);
                                } finally {
                                    SEARCH_BTN.innerText = original_btn_text;
                                    SEARCH_BTN.disabled = false;
                                    // 隱藏進度條
                                    hideProgress();
                                }
                            });
                        </script>
                    </div>

                    <div class="container">
                        <h2>土地資訊</h2>
                        <p class="description">瞭解您關心的地點周邊土地使用分區及環境資訊</p>
                        <div id="zoning-details">
                            <p>請先在左側輸入地址進行查詢，查詢結果將顯示於此處。</p>
                            <div class="notice">土地使用分區資訊將自動顯示在這個區塊</div>
                        </div>
                    </div>

                    <div class="container">
                        <h2>地價資訊</h2>
                        <p class="description">了解當前地址的公告地價與公告現值</p>
                        <div id="price-info">
                            <p>請先在左側輸入地址進行查詢，查詢結果將顯示於此處。</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 第二頁：使用說明 -->
            <div class="page" id="page2">
                <div class="page-content">
                    <div class="container" style="width: 1150px;">
                        <h2>室內規劃</h2>
                        <p class="description">輸入數值來產生平面圖</p>
                        <div style="display: flex;justify-content: space-between;">
                            <div style="width: 300px;">
                                <div class="input-rows">
                                    <div class="input-row">
                                        <label for="building_area_m2">building_area_m2</label>
                                        <input id="building_area_m2" class="text-input" type="number"
                                            placeholder="building_area_m2 (平方公尺)" required>
                                    </div>
                                    <div class="input-row">
                                        <label for="total_units">total_units</label>
                                        <input id="total_units" class="text-input" type="number"
                                            placeholder="total_units (戶數)" required>
                                    </div>
                                    <div class="input-row">
                                        <label for="public_ratio">public_ratio</label>
                                        <input id="public_ratio" class="text-input" type="number"
                                            placeholder="public_ratio（比值）" required>
                                    </div>
                                    <div class="input-row">
                                        <label for="balcony_depth">balcony_depth</label>
                                        <input id="balcony_depth" class="text-input" type="number"
                                            placeholder="balcony_depth（公尺）" required>
                                    </div>
                                    <div class="input-row">
                                        <label for="unit_spacing">unit_spacing</label>
                                        <input id="unit_spacing" class="text-input" type="number"
                                            placeholder="unit_spacing" required>
                                    </div>
                                    <div class="input-row">
                                        <label for="arrangement_type">arrangement_type</label>
                                        <select id="arrangement_type" class="text-input" type="number" required
                                            placeholder="arrangement_type">
                                            <option value="L">僅左側</option>
                                            <option value="R">僅右側</option>
                                            <option value="T">僅上側</option>
                                            <option value="B">僅下側</option>
                                            <option value="LR">左右兩側</option>
                                            <option value="TB">上下兩側</option>
                                        </select>
                                    </div>
                                    <div class="input-row">
                                        <label for="m2_to_ping">m2_to_ping</label>
                                        <input id="m2_to_ping" class="text-input" type="number"
                                            placeholder="m2_to_ping">
                                    </div>
                                </div>
                                <div class="input-rows">
                                    <button id="floorGenerateBtn" type="button" onclick="generateFloor()"
                                        style="width: 100%;">生成</button>
                                </div>
                            </div>
                            <div id="floorPlan" class="result-box"
                                style="width: 800px; height: 850px; margin-top: 20px;display: flex;justify-content: center;align-items: flex-start;">
                            </div>
                        </div>
                        <script>
                            const FLOOR_GENERATE_BTN = document.getElementById('floorGenerateBtn');
                            const FLOOR_PLAN = document.getElementById('floorPlan');
                            const generateFloor = async () => {
                                FLOOR_GENERATE_BTN.innerText = '生成中...';
                                FLOOR_GENERATE_BTN.disabled = true;
                                FLOOR_PLAN.innerHTML = SPINNER_HTML;
                                showProgress();
                                const reqData = {
                                    building_area_m2: document.getElementById('building_area_m2').value,
                                    total_units: document.getElementById('total_units').value,
                                    public_ratio: document.getElementById('public_ratio').value,
                                    balcony_depth: document.getElementById('balcony_depth').value,
                                    arrangement_type: document.getElementById('arrangement_type').value,
                                    unit_spacing: document.getElementById('unit_spacing').value,
                                    m2_to_ping: document.getElementById('m2_to_ping').value ? document.getElementById('m2_to_ping').value : null,
                                }
                                try {
                                    // 檢查required欄位是否填寫
                                    for (const key in reqData) {
                                        // 如果標為required
                                        if (document.getElementById(key).hasAttribute('required') && reqData[key] === '') {
                                            // 如果欄位為空，則顯示提示訊息
                                            return alert(`${key} 欄位必填`);
                                        }
                                    }

                                    const res = await fetch(`/api/generate-floor`, {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json'
                                        },
                                        body: JSON.stringify(reqData)
                                    });
                                    const resJson = await res.json();

                                    if (!res.ok) {
                                        const message = `查詢失敗，伺服器 ${res.status}` + resJson ? `\n${resJson.message}` : '';
                                        FLOOR_PLAN.innerText = message;
                                        throw new Error(message);
                                    }
                                    const data = resJson.data;
                                    FLOOR_PLAN.innerHTML = data;
                                } catch (error) {
                                    FLOOR_PLAN.innerText = error.message;
                                    alert(error.message);
                                    console.error('Error:', error);
                                } finally {
                                    FLOOR_GENERATE_BTN.innerText = '生成';
                                    FLOOR_GENERATE_BTN.disabled = false;
                                    // 隱藏進度條
                                    hideProgress();
                                }
                            }

                        </script>
                    </div>
                </div>
            </div>

            <!-- 第三頁：關於我們 -->
            <div class="page" id="page3">
                <div class="page-content">
                    <div class="container">
                        <h2>關於我們</h2>
                        <p>NeighborGIS 納博聚思是一個專注於地理資訊系統的服務平台，致力於提供使用者簡單易用的地址查詢及分區資訊服務。</p>
                        <p>我們的目標是讓每個人都能夠輕鬆獲取土地使用分區、容積率、建蔽率等關鍵資訊，協助使用者更好地了解自己的居住環境。</p>
                        <p>如有任何建議或問題，歡迎聯絡我們。</p>
                    </div>

                    <div class="container">
                        <h2>團隊介紹</h2>
                        <p class="description">我們的專業團隊</p>
                        <p>納博聚思由一群熱愛地理資訊系統的專家組成，團隊成員擁有豐富的GIS經驗和專業知識。</p>
                        <p>我們致力於將複雜的地理資訊簡化，讓每個人都能輕鬆理解和應用。</p>
                    </div>

                    <div class="container">
                        <h2>聯絡我們</h2>
                        <p class="description">有任何問題或建議嗎？</p>
                        <p>電子郵件：info@neighborgis.com</p>
                        <p>地址：台北市信義區信義路五段7號</p>
                        <p>電話：02-12345678</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="left-right-btn" id="next-btn"></div>
        <script src="assets/left_right_btn.js"></script>
    </main>

    <script src="assets/switch_page.js"></script>

    <script src="assets/required_input.js"></script>

    <footer>
        <p>© <span id="copyright-year"></span> NeighborGIS. All rights reserved.</p>
        <p>Powered by <a class="link" href="https://hazelnut-paradise.com/">榛果繽紛樂</a></p>
        <script>
            const currentYear = new Date().getFullYear();
            document.getElementById('copyright-year').textContent = currentYear;
        </script>
    </footer>
</body>

</html>